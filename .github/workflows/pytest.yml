name: Pytest

on:
  pull_request:

jobs:
  pytest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Restore virtual environment cache
        id: venv-cache
        uses: actions/cache@v4
        with:
          path: .venv
          key: >-
            venv-${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-
            ${{ hashFiles('requirements.txt', 'pyproject.toml') }}

      - name: Install dependencies
        shell: bash
        env:
          VENV_CACHE_HIT: ${{ steps.venv-cache.outputs.cache-hit }}
        run: |
          set -euxo pipefail

          # Create virtual environment if missing
          if [ ! -x ".venv/bin/python" ]; then
            python -m venv .venv
          fi

          source .venv/bin/activate
          python -m pip install --upgrade pip

          # Install third-party dependencies on cache miss
          if [ "${VENV_CACHE_HIT}" != "true" ]; then
            # Exclude unnecessary dependencies
            grep -vE '^(matplotlib|torch|ruff|pre-commit)\b' requirements.txt > /tmp/requirements-ci.txt
            pip install -r /tmp/requirements-ci.txt

            # Explicitly install CPU-only PyTorch wheels.
            pip install --index-url https://download.pytorch.org/whl/cpu torch
          fi

          pip install -e . --no-deps

      - name: Pytest
        shell: bash
        run: |
          source .venv/bin/activate
          python -m pytest tests
